'use strict';
var model = {
  houses: [
    {
      "id": 7557,
      "description": "Large four bedroom family home with panoramic city/harbour views.\n\nFeatures swimming pool, four large bedrooms, three balconies, built-in wardrobes, rumpus room, separate lounge/dining rooms, modern kitchen with two dishwashers, modern bathroom plus guest toilets, internal laundry, backyard, double lock up garage. \n\nClose to shops and transport.",
      "address": {
        "street_number": "21",
        "street_name": "Gilbert Street",
        "suburb": "DOVER HEIGHTS",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.871627,
        "longitude": 151.278074
      },
      "price": 1600,
      "garage_spaces": 2,
      "bedrooms": 4,
      "bathrooms": 1,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/167e0a732ee216111eda51b407f178e16ba6292e",
              "width": 800,
              "height": 531
            },
            "medium": {
              "url": "http://img.agentaccount.com/6e14148d6208f1615d810ea1d0eca5253d09114d",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/d807dc0345c0cb4297d9cdc7b90a465f5f458744",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 7688,
      "description": "Moments away from Watson's Bay, in a quiet dress cycle location, this substantial  home offers 5 bedroom, four bathrooms with panoramic city/harbour views.  \n\nIt features superb indoor /outdoor entertaining area with a pool, modern kitchen, beautifully appointed bathrooms, spacious lounge with breathtaking views, separate formal dining area, internal laundry, two car spaces.",
      "address": {
        "street_number": "22",
        "street_name": "Russell Street",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.848721,
        "longitude": 151.283599
      },
      "price": 3000,
      "garage_spaces": 2,
      "bedrooms": 5,
      "bathrooms": 4,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/455769eb4ab8faee61b257180f7d5cf919d9486a",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/c20d7662b735064dda394f6d3e4fbe30bff409af",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/94f71030ba29709ec6b8edbdaeec528bccaca7c0",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 16106,
      "description": "In an idyllic peaceful setting sits this impressive 2 storey residence. Perched in a desirable cul-de-sac location enjoying a sunny north east aspect this home oozes with luxury. Boasting 4-5 large bedrooms master with ensuite and walk in robe, stylish bathrooms and views of the garden and pool from every room.\r\n\r\nA flowing floor plan leading to a private and secluded entertainment area with inground pool, vast use of travertine throughout a two car garage, home office and rumpus room completes the picture.\r\n",
      "address": {
        "street_number": "24",
        "street_name": "Ray Avenue",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.860706,
        "longitude": 151.274928
      },
      "price": 3300000,
      "garage_spaces": 2,
      "bedrooms": 5,
      "bathrooms": 2,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/f1075291162b9b1d83d98e972541f45cc6df9796",
              "width": 800,
              "height": 600
            },
            "thumb": {
              "url": "http://img.agentaccount.com/3d666b158db7163e05a88caff8d29dda123598fe",
              "width": 200,
              "height": 150
            },
            "medium": {
              "url": "http://img.agentaccount.com/7a6361766060bd1f53e130f9b5b97729d8105e7a",
              "width": 400,
              "height": 300
            }
          }
        }
      }
    },
    {
      "id": 24070,
      "description": "Spacious two to three bedroom semi in a quiet street. Features two bedrooms with a third room to be possibly utilised as a third bedroom or a study, large front terrace, modern kitchen, modern bathroom, freshly polished timber floorboards, fresh paint, new blinds, new light fittings, separate lounge and dining areas, internal laundry with a guest toilet, large backyard, tandem lock-up garage. - PETS ACCEPTED -",
      "address": {
        "street_number": "17",
        "street_name": "Ethel Street",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.864609,
        "longitude": 151.281923
      },
      "price": 750,
      "garage_spaces": 2,
      "bedrooms": 2,
      "bathrooms": 1,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/4cdbf91a83411154b567b918b7c4f7b85313436a",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/9b342556a36aa207ab41823fea559050e91171fb",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/845271f39ff6d280489f9616e83a62b663f4577b",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 25948,
      "description": "Huge bright renovated 4-6 bedroom house. Features ocean & district views, new polished floorboards throughout, fresh paint, brand new eat-in kitchen with breakfast bar and dishwasher, 'L' shaped lounge/dining, separate formal lounge or 5th bedroom, separate study/6th bedroom, main bathroom with separate bath and shower, spacious internal laundry with 2nd toilet & shower, huge north facing garden with external toilet, single lock-up garage.  Quiet location, close to transport.",
      "address": {
        "street_number": "3",
        "street_name": "Loombah Road",
        "suburb": "DOVER HEIGHTS",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.880124,
        "longitude": 151.280486
      },
      "price": 1495,
      "garage_spaces": 1,
      "bedrooms": 4,
      "half_bedroom": "0",
      "bathrooms": 2,
      "half_bathroom": "0",
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/09883db6238c2f82be0765b9c4d20c834b9446c4",
              "width": 800,
              "height": 567
            },
            "medium": {
              "url": "http://img.agentaccount.com/2182d07d6308a476d60eabbcf49ec4560747f18f",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/df63a64ed5a09ce09ac8824bb1a01d22f89ca2e3",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 57071,
      "description": "Bright modern one bedroom unit in a security building.  Features fanastic ocean and coastal view, renovated kitchen, combined lounge/dining, good sized balcony, modern bathroom with separate shower & bath, large bedroom with mirrored built-in wardrobe, own parking space and separate laundry/storeage.  Great location minutes from coles, transport, amenities & Kimberley park as well as the famous coastal cliff walk.",
      "address": {
        "street_number": "5-7",
        "street_name": "Kimberley Street",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.863213,
        "longitude": 151.281636
      },
      "price": 400,
      "garage_spaces": 1,
      "bedrooms": 1,
      "bathrooms": 1,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/f3249b19e257733a13eb801d94a1f362aac8ad2f",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/32c56f296db3bd503a541dcfff08d5ec0d401505",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/cad9f19a3ed0f70e566686eae799c31d8a95a327",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 2235456,
      "description": "This large contemporary family home has iconic Sydney Harbour views taking centre-stage. Displaying the CBD, Opera House, Bridge and NYE fireworks, this architecturally designed as-new home is ideal for poolside entertaining and an easycare indoor/outdoor family lifestyle. Focused on quality, versatility and spell-binding views both day and night, the open plan layout flows to extensive balconies, travertine terraces, sunny level private garden, glass balustraded infinity spa & 11m fully-tiled pool (solar heated). Freestanding on a large level block in an exclusive enclave, the sun-splashed home is quiet and private, yet convenient to an extensive choice of village shops, top schools, idyllic beaches, places of worship, parks and transport.\r\n\r\n- Landscaped travertine forecourt, water feature, large foyer\r\n- Expansive main open plan formal living and dining areas\r\n- Open family zone adjoins oversized kitchen/breakfast bar\r\n- CaesarStone benchtops, Ilve gas hob, oven, 2 Miele dishwashers, massive storage\r\n- Separate family/TV room or additional large bedroom\r\n- 5 upstairs bedrooms includes lavish master suite with walk-in robe\r\n- 4 marble bathrooms (2 ensuites) with quality fittings, heated floors\r\n- 2 additional guest powder rooms, internal laundry room\r\n- Separate large playroom or teenage retreat with wet bar\r\n- Abundant built-in storage on all 3 floors, various store rooms\r\n- High ceilings, plantation shutters, polished timber floors\r\n- Ducted air con, back to base security system\r\n- Private driveway, huge garage could accommodate up to 6 cars (internal access)",
      "address": {
        "street_number": "2B ",
        "street_name": "Nulla Street ",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.860584,
        "longitude": 151.274347
      },
      "price": 2000000,
      "garage_spaces": 4,
      "bedrooms": 6,
      "bathrooms": 4,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/230a60857156941af9101bcab6d1bee96afefe71",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/474a5873ebbea1004b51b256b835dccc2a96bd7e",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/98ab63815b76c7bac2c0a9eb82d2d8d71aa51b44",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 2235495,
      "description": "Designed to Impress.... there is just so much to love about this home!\r\n\r\nDefined by modern design, glass-embraced interiors and a sun-soaked aspect with stunning views, this substantial low maintenance harbourside home is immaculately presented and ready for a contemporary lifestyle.\r\n\r\nIn a secluded cul-de-sac overlooking the harbor and spread easily over 2 expansive levels of living, this substantial residence is set on secure grounds with superb elevation and spectacular uninterrupted views of Sydney Harbour.\r\n\r\nSpacious & luxurious interiors are complemented by scenic terraces, providing effortless all year round indoor & outdoor entertaining, while the view provides a captivating backdrop any time of the day or night.\r\n\r\nFormerly used as a private residence by the Canadian consulate, the home is a showcase of architectural excellence.\r\n\r\nSuperbly convenient only minutes to harbour beaches, cafes, transport and exclusive schools.\r\n\r\n+Flexible floorplan offers 5 bedrooms, 3 bathrooms\r\n+ Enormous formal living & separate dining rooms\r\n+Multiple additional informal entertaining areas\r\n+Stunning conservatory with cathedral ceilings\r\n+Modern kitchen\r\n+ Sundrenched level gardens surrounded by lush low maintenance landscaping\r\n+ DLUG + additional o/s secure parking\r\n\r\nDion Markovics 0407 667 037\r\n9327 7976| lsdb.com.au\r\nLaing+Simmons | Double Bay\r\n\r\nD'Leanne Lewis 0419 676 667\r\n8356 7916| lsdb.com.au\r\nLaing+Simmons | Double Bay",
      "address": {
        "unit_number": "",
        "street_number": "1",
        "street_name": "Graylind Place",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.859527,
        "longitude": 151.272910
      },
      "price": 600000,
      "garage_spaces": 2,
      "bedrooms": 5,
      "bathrooms": 3,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/8bf22e745fb696d9e3beee0749b878e134665094",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/000273fc90fab17d0577a87a9c2d2c2885c958e5",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/aed0691e72f633894eaa8e0b20af88c45c39e1aa",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 2235870,
      "description": "Set high on a magnificently landscaped 1195sqm block, capturing breathtaking vistas over Sydney Harbour, the Bridge and Opera House from a superb selection of living and entertaining areas. Designed by renowned architect F. Glynn Gilling, this historic 1920â€™s manor has retained a wonderful sense of old world opulence and Spanish Mission inspired charm. Ready to be customised and restored to its former grandeur, this extraordinarily versatile home is a showcase of majestic proportions and elegant traditional detailing. Ultimately convenient, only minutes to Rose Bay village cafes, parks, ferries and waterfront while top local schools are within easy walking distance.\r\n\r\n-4 huge bedrooms\r\n-2 bathrooms + guest powder room\r\n-Triple car garage\r\n-Numerous harbour/garden view terraces\r\n-Classically appointed formal rooms\r\n-Vast family room, wide level lawns\r\n-Stylish modern eat-in gas kitchen\r\n-Luxuriously large master suite\r\n-Timber floors",
      "address": {
        "street_number": "1",
        "street_name": "Vaucluse Road",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.860833,
        "longitude": 151.270527
      },
      "price": 2000000,
      "garage_spaces": 3,
      "bedrooms": 4,
      "bathrooms": 2,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/ccc927c12a1e946227081f882736d966e11d7f9c",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/fb57ea5ba8632048490482fda058a3579655c107",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/3ce26112eafaf8bbd48c44216eb2a80286b19504",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 2235926,
      "description": "Spanning 500sqm (approx.) of internal/external living space, this modern masterpiece is set against a mesmerising 180-degree harbour backdrop. Its panorama stretches to the city skyline, Bridge, Opera House and across to North Sydney.\r\n\r\nPrivately located on the prized lower section of Vaucluse Road, the residence has undergone a three year refurbishment, combining the home's classic period origins with modern architecture. The open plan design makes for effortless indoor/outdoor entertaining whilst the 3 metre ceilings help capture the stunning view.\r\n\r\nIt accommodates four bedrooms and five bathrooms, including a master suite with marble ensuite, study, large dressing room and adjoining sitting room.\r\n\r\nThe home offers a gourmet designer kitchen with a breakfast bar as well as a large scullery/butler's pantry - perfect for entertaining. There is also a separate wine cellar and tasting room as well as an office/study on the lower level.\r\n\r\nAdditional features include two powder rooms, vast storage, ducted a/c, surround sound, large internal laundry, security system, double garage with internal access, and DA approval for an elevated infinity pool and additional accommodation.\r\n\r\nNestled above Queens Beach, this private residence is convenient to elite schools and represents a rare opportunity to acquire an amazing home.\r\n\r\nCouncil: $3,318.07 pa\r\nWater: $706.24 pa",
      "address": {
        "street_number": "8",
        "street_name": "Vaucluse Road",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.860710,
        "longitude": 151.270040
      },
      "price": 2000000,
      "garage_spaces": 2,
      "bedrooms": 4,
      "bathrooms": 5,
      "ensuite": 1,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/b36f8d883e1f917781747aa13129dd7888b7b954",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/ae14af6e5eb6413e59b94824006b55dd59cd014e",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/3983ccd84ec502221acbb3272e2bf7b109bfbf2b",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    },
    {
      "id": 2236010,
      "description": "Over half an acre of immediate harbour-side blue ribbon real estate. A serene and leafy haven with northerly views across Vaucluse Bay and the harbour. \"Loch Maree\" is tucked away in a prestigious cul-de-sac enclave. With original and inspired design by Michael Dysart, the home embraces and reflects the simplicity of nature, both indoors and out, and offers a lifestyle to match with direct access to the harbour beach, lush tropical gardens, heated pool and its own championship tennis court. This unique home features 14th century stone floors, a Leonard French stained glass window and is wonderfully versatile for entertaining in style or as a private family residence.\r\n\r\n- Choice of over-sized living and dining areas\r\n- Sun soaked terraces, shady courtyards\r\n- Generous master suite with walk-in robes\r\n- Self-contained boathouse with slipway\r\n- Home theatre/simulated driving range\r\n- Self-contained office, air conditioning\r\n- Heated pool, championship tennis court\r\n- Secluded tree filled garden, level lawn\r\n- Garaging for six cars or more\r\n- Once in a lifetime opportunity\r\n\r\nTo inspect please contact:\r\nBob Guth 0403 585 585\r\n\r\nor Co-Agent\r\nMichael Pallier 0417 371 522\r\nSydney Sothebys International Realty",
      "address": {
        "street_number": "1A",
        "street_name": "Loch Maree Place",
        "suburb": "VAUCLUSE",
        "postcode": "2030",
        "region": "Eastern Suburbs",
        "state": "NSW",
        "country": "Australia",
        "latitude": -33.853005,
        "longitude": 151.272501
      },
      "price": 2000000,
      "garage_spaces": 6,
      "bedrooms": 6,
      "bathrooms": 3,
      "ensuite": 2,
      "photos": {
        "1": {
          "versions": {
            "large": {
              "url": "http://img.agentaccount.com/61bfdc7f4cb66f8bc4170572a14a9dfd1deae4b6",
              "width": 800,
              "height": 600
            },
            "medium": {
              "url": "http://img.agentaccount.com/466c91deeb8ae2ce17ff69fb28e9f3258edd8ae4",
              "width": 400,
              "height": 300
            },
            "thumb": {
              "url": "http://img.agentaccount.com/c83635385ebcf46208251eae31e64f864e2f038a",
              "width": 200,
              "height": 150
            }
          }
        }
      }
    }
  ],
  //Sets the fav attribute of the given house to true or false
  updatingHouses: function(house){
    house.fav(house.fav());
  }
}

var House = function(data){
  this.id = data.id;
  this.address = data.address.street_number+" "+data.address.street_name + ", "+ data.address.postcode+" "+data.address.suburb+" "+data.address.state;
  this.coords = { 'lat': data.address.latitude, 'lng': data.address.longitude};
  this.lat = data.address.latitude;
  this.lng = data.address.longitude;
  this.garage = data.garage_spaces;
  this.bedrooms = data.bedrooms;
  this.bathrooms = data.bathrooms;
  this.description = data.description;
  this.ensuite = data.ensuite;
  this.photos = data.photos;
  this.price = data.price;
  this.fav = ko.observable(false);
}

//Create an observable array to used in view and not access directly to model
var ViewModel = {
  houseArray: ko.observableArray([]),
  init: function() {
      var self = this;

      //populating the array
      model.houses.forEach(function(house){
          ViewModel.houseArray.push(new House(house));
      });

      //Updating the model and the marker in the view
      this.updatingfavourites = function(){
        model.updatingHouses(this);
        view.updateMarker(this);
        return true;
      }

      //filtering the houses
      this.filter = ko.observable();
      this.filterHouses = ko.computed(function() {
          var myfilter = self.filter();
          if(!myfilter){
            return ViewModel.houseArray();
          }else{
            var all = ViewModel.houseArray();
            var done = [];
            for (var i = 0; i < all.length; i++){
              if(all[i].address.toLowerCase().includes(myfilter.toLowerCase())){
                  done.push(all[i]);
              }
            }
          }
          view.hideMarkers();
          view.setMarkers(done);
          return done;
      });

      //getting the location of the requested service
      this.getServices = function(service){
        if (document.getElementById(service).checked) {
          var places = new google.maps.places.PlacesService(view.map);
          var latlng = {lat: view.map.getCenter().lat(), lng: view.map.getCenter().lng()};
          var request = {
            location: latlng,
            radius: '1000',
            types: [service]
          };
          //using Google Places to search for nearby services
          places.nearbySearch(request, function(results, status){
            if (status == google.maps.places.PlacesServiceStatus.OK) {
              view.showServicesMarkers(results, service);
            }else if(status == google.maps.places.PlacesServiceStatus.ZERO_RESULTS){
              $('#alert .modal-title').html('Google Places results');
              $('#alert .modal-body').html('<p>No results looking for "' + service +'".</p>');
              $('#alert').modal('show');
            }else{
              $('#alert .modal-title').html('Google Places results');
              $('#alert .modal-body').html('<p>An error ocurred: ' + status+'.</p>');
              $('#alert').modal('show');
            }
          });
        } else {
          view.hideServicesMarkers(service);
        }
      }

      //getting the beaches in the area using Foursquare API
      this.getBeaches = function(){
        //function formats current date to be used in parameter v in Foursquare ajax call
        Date.prototype.yyyymmdd = function() {
          var mm = this.getMonth() + 1; // getMonth() is zero-based
          var dd = this.getDate();
          return [this.getFullYear(),
                  (mm > 9 ? '' : '0') + mm,
                  (dd > 9 ? '' : '0') + dd
                 ].join('');
        };

        var date = new Date();
        //if checkbox is checked
        if (document.getElementById('beaches').checked) {
          var foursquareURL = 'https://api.foursquare.com/v2/venues/search';
          $.ajax({
            url: foursquareURL,
            method: 'GET',
            data: {'ll': view.map.getCenter().lat() + "," + view.map.getCenter().lng(),
             'client_id': 'BRBMAYIFF3TVSAJ3AKGSBNXCWYOOLYYZVHRODRYXVIUS4211',
             'client_secret': 'ZCTIVDJXJEEXNFZ3SBF4JDYH1KXAPDQVS1TBINFNZOCST2VG',
             'v': date.yyyymmdd(),
             'limit': 20,
             'radius': 10000,
             'categoryId': '4d4b7105d754a06377d81259'
           }
         }).done(function(data){
              if(data.response.venues.length > 0){
                view.showBeaches(data.response.venues);
              //if results length is 0
              }else{
                $('#alert .modal-title').html('Foursquare results');
                $('#alert .modal-body').html('<p>No results.</p>');
                $('#alert').modal('show');
              }
          }).fail(function(){
            $('#alert .modal-title').html('Foursquare results');
            $('#alert .modal-body').html('<p>An error ocurred.</p>');
            $('#alert').modal('show');
          });
        //if checkbox is unchecked
        }else{
          view.hideServicesMarkers('beaches');
        }
      }

      //function to open the panel
      var drawer = document.querySelector('.nav');
      this.showMenu = function() {
        drawer.classList.toggle('open');
      }

      //function to close the panel
      this.removeMenu = function() {
        drawer.classList.remove('open');
      }

      //function to show/hide the services
      this.showServices = function(){
        $('#divservices').toggleClass('services');
        $('#school').prop("checked", !$('#school').prop("checked"));
        $('#doctor').prop("checked", !$('#doctor').prop("checked"));
        $('#shopping_mall').prop("checked", !$('#shopping_mall').prop("checked"));
        $('#beaches').prop("checked", !$('#beaches').prop("checked"));
        $('#btnservices').toggle(this.getServices('school'),view.hideServicesMarkers('school'));
        $('#btnservices').toggle(this.getServices('doctor'),view.hideServicesMarkers('doctor'));
        $('#btnservices').toggle(this.getServices('shopping_mall'),view.hideServicesMarkers('shopping_mall'));
        $('#btnservices').toggle(this.getBeaches(),view.hideServicesMarkers('beaches'));
      }
  }
};

var view = {
  map: {},
  markers: [],
  schoolMarkers: [],
  doctorMarkers: [],
  shopping_mallMarkers: [],
  beachesMarkers: [],
  infowindowArray: [],
//Initialiasing the map
  initMap: function(){
    var center = {lat: -33.856182, lng: 151.277570};
    this.map = new google.maps.Map(document.getElementById('map'), {
            center: center,
            zoom: 15,
            mapTypeControl: true,
            mapTypeControlOptions: {
                style: google.maps.MapTypeControlStyle.HORIZONTAL_BAR,
                position: google.maps.ControlPosition.TOP_RIGHT
            }
    });

    //capture the escape key event to close the infowindows
    $(document).on('keyup',function(evt) {
        if (evt.keyCode == 27) {
           view.closeInfowindow();
        }
    });

    //calling the data once the map is loaded
    ko.applyBindings(new ViewModel.init());

    //creating the markers
    this.setMarkers(ViewModel.houseArray());

  },
  //create the object google.maps.Marker
  createMarker: function(map, position, title, icon, id){
    var marker = new google.maps.Marker({
      map: map,
      position: position,
      title: title,
      animation: google.maps.Animation.DROP,
      icon: icon,
      id: id
    });
    return marker;
  },
  //setting the model markers
  setMarkers: function(arrayLocations){
    var self = this;
    var marker;
    var bounds = new google.maps.LatLngBounds();
    //Parameter passing the data from ViewModel
    var locations = arrayLocations;
    var infowindow = new google.maps.InfoWindow();

    for (var i = 0; i < locations.length; i++) {
      //depending on fav attribute the marker icon is different
      if(locations[i].fav()){
        self.marker = self.createMarker(view.map,locations[i].coords, locations[i].address,'images/star-3.png', locations[i].id);
      }else{
        self.marker = self.createMarker(view.map,locations[i].coords, locations[i].address,'images/home-2.png', locations[i].id);
      }
      //populate the markers array
      this.markers.push(self.marker);
      //create the infowindows
      this.createInfowindow(self.marker, infowindow, locations[i], null);

    }
  //adding the markers to the map
    for (var i = 0; i < this.markers.length; i++) {
      this.markers[i].setMap(this.map);
      bounds.extend(view.markers[i].position);
    }
    //Centering the map to the markers
    this.map.fitBounds(bounds);
  },
  //function that hides the markers
  hideMarkers: function(){
    for (var i = 0; i < this.markers.length; i++) {
      this.markers[i].setMap(null);
    }
    this.markers = [];
  },
  //create the infowindows
  createInfowindow: function(marker, infowindow, house, service){
    var self = this;
    //adding infowindow to markers
    marker.addListener('click', (function(copyLocations){
      return function(){
        self.setInfoWindows(this, infowindow, copyLocations, null);
      }
    })(house));

  },
  //update the marker in case of favourite
  updateMarker: function(house){
    var self = this;
    var marker;
    var infowindow = new google.maps.InfoWindow();
    //Select the marker of the selected house
    var indexSelected;
    for (var i = 0; i < this.markers.length; i++) {
      if(this.markers[i].id === house.id){
        indexSelected = i;
        break;
      }
    }
    var markerSelected = this.markers[indexSelected];
    //delete the marker from the map
    markerSelected.setMap(null);
    //remove the marker from the markers array
    this.markers.splice(indexSelected, 1);
    markerSelected = null;

    if(house.fav()){
      marker = this.createMarker(this.map,house.coords,house.address,'images/star-3.png', house.id);
      //add the marker to the markers array in the correct position
      this.markers.splice(indexSelected, 0, marker);
    }else{
      marker = this.createMarker(this.map,house.coords,house.address,'images/home-2.png', house.id);
      //add the marker to the markers array in the correct position
      this.markers.splice(indexSelected, 0, marker);
    }
    //create the infowindow for the marker
    this.createInfowindow(marker, infowindow, house, null);
  },
  //setting the content of the infowindow
  setInfoWindows: function(marker, infowindow, house, service){
    // *
    //Idea and part of code from http://en.marnoto.com/2014/09/5-formas-de-personalizar-infowindow.html

    // START INFOWINDOW CUSTOMIZE.
    // The google.maps.event.addListener() event expects
    // the creation of the infowindow HTML structure 'domready'
    // and before the opening of the infowindow, defined styles are applied.
    // *
    google.maps.event.addListener(infowindow, 'domready', function() {

      // Reference to the DIV that wraps the bottom of infowindow
      var iwOuter = $('.gm-style-iw');

      /* Since this div is in a position prior to .gm-div style-iw.
       * We use jQuery and create a iwBackground variable,
       * and took advantage of the existing reference .gm-style-iw for the previous div with .prev().
      */
      var iwBackground = iwOuter.prev();
      // Removes background shadow DIV
      iwBackground.children(':nth-child(2)').css({'display' : 'none'});
      // Removes white background DIV
      iwBackground.children(':nth-child(4)').css({'display' : 'none'});
      // Changes the desired tail shadow color.
      iwBackground.children(':nth-child(3)').find('div').children().css({'box-shadow': 'rgba(72, 181, 233, 0.6) 0px 1px 6px', 'z-index' : '1'});

      // Reference to the div that groups the close button elements.
      var iwCloseBtn = iwOuter.next();
      var imgBtn = $(iwCloseBtn).find('img');
      //Making the close button image bigger
      imgBtn.css({left: '-2px', top: '-394px', width: '85px', height: '580px'});
      // Apply the desired effect to the close button
      iwCloseBtn.css({background: 'white', opacity: '1', right: '35px', top: '-4px', padding: '10px', width:'12px', height:'12px', border: '1px solid #48b5e9', 'border-radius': '10px', 'box-shadow': '0 0 5px #3990B9'});
      // The API automatically applies 0.7 opacity to the button after the mouseout event. This function reverses this event to the desired value.
      iwCloseBtn.mouseout(function(){
        $(this).css({opacity: '0.5'});
      });

      // If the content of infowindow not exceed the set maximum height, then the gradient is removed.
      if($('.content').height() < 332){
        $('.iw-bottom-gradient').css({display: 'none'});
      }
    });

    //setting the content
    var content;
    if(house){
      var streetview = 'https://www.google.com/maps/embed/v1/streetview?location=' + house.lat + ',' + house.lng +'&key=AIzaSyC4dYdTtAuclPLAGpEg-1UQ947LrilnwkI';
      $('.infowindow .bgimg').attr('src', house.photos[1].versions.medium.url);
      $('.infowindow .address').html(house.address);
      $('.infowindow .bed').html('Bedrooms: ' + house.bedrooms);
      $('.infowindow .bath').html('Bathrooms: ' + house.bathrooms);
      $('.infowindow .ensuite').html('Ensuite: ' + house.ensuite);
      $('.infowindow .garage').html('Garage spaces: ' + house.garage);
      $('.infowindow .price').html('Price: $' + house.price);
      $('.infowindow .description').html(house.description);
      $('.infowindow .street').html('<iframe src="" class="view" allowfullscreen>Google Streetview could not be loaded.</iframe>');
      $('.infowindow .view').attr('src', streetview);
      content = $('.infowindow').html();
    }else{
      var streetview = 'https://maps.googleapis.com/maps/api/streetview?location=' + marker.title + '&key=AIzaSyC4dYdTtAuclPLAGpEg-1UQ947LrilnwkI&size=400x300';
      $('.infowindowservice .bgimgservice').attr('src', streetview);
      $('.infowindowservice .address').html(marker.title);
      content = $('.infowindowservice').html();
    }
    //adding content to infowindow
    infowindow.setContent(content);

    //adding the infowindow to array to close them all
    this.infowindowArray.push(infowindow);

    //open the infowindow
    if (infowindow.marker != marker) {
      infowindow.open(this.map, marker);
    }

    //close the infowindow
    infowindow.addListener('closeclick', function(){
      infowindow.marker = null;
    });
  },
  //closing the infowindows
  closeInfowindow: function(){
    for(var i = 0;i < this.infowindowArray.length; i++){
      this.infowindowArray[i].close();
    }
  },
  //showing the services markers
  showServicesMarkers: function(results, service){
    var marker;
    var infowindow = new google.maps.InfoWindow();
    for (var i = 0; i < results.length; i++) {
      var title = results[i].name + " " + results[i].vicinity;
      marker = this.createMarker(this.map,results[i].geometry.location, title, 'images/' + service + '.png', i);
      //populating the arrays
      if(service === 'school'){
        this.schoolMarkers.push(marker);
      }else if (service === 'doctor') {
        this.doctorMarkers.push(marker);
      }else{
        this.shopping_mallMarkers.push(marker);
      }
      this.createInfowindow(marker, infowindow, null, service);
    }
  },
  //showing the beaches
  showBeaches: function(results){
    var marker;
    var infowindow = new google.maps.InfoWindow();
    for (var i = 0; i < results.length; i++) {
        var coords = {lat: results[i].location.lat, lng: results[i].location.lng};
        var title = results[i].name + " " + results[i].location.address + ", " + results[i].location.city + " " + results[i].location.postalCode;
        marker = this.createMarker(this.map, coords, title, 'images/beach.png', i);
        //populating the array
        this.beachesMarkers.push(marker);
        this.createInfowindow(marker, infowindow, null, "beach");
    }
  },
  //hiding the services markers
  hideServicesMarkers: function(service){
    if(service === 'school' && this.schoolMarkers.length > 0){
      for (var i = 0; i < this.schoolMarkers.length; i++) {
        this.schoolMarkers[i].setMap(null);
      }
      this.schoolMarkers = [];
    }else if (service === 'doctor' && this.doctorMarkers.length > 0) {
      for (var i = 0; i < this.doctorMarkers.length; i++) {
        this.doctorMarkers[i].setMap(null);
      }
      this.doctorMarkers = [];
    }else if (service === 'shopping_mall' && this.shopping_mallMarkers.length > 0) {
      for (var i = 0; i < this.shopping_mallMarkers.length; i++) {
        this.shopping_mallMarkers[i].setMap(null);
      }
      this.shopping_mallMarkers = [];
    }else{
      for (var i = 0; i < this.beachesMarkers.length; i++) {
        this.beachesMarkers[i].setMap(null);
      }
      this.beachesMarkers = [];
    }
  }
}
