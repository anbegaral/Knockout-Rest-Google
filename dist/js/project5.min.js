var model={houses:[],getData:function(){model.houses=[];var urlapi="http://api2.agentaccount.com:80/properties.json",found=!1;$.ajax({method:"GET",url:urlapi,data:{token:"827f01934ab7e1f007eda5b79141aa28f6623d61",postcode:"2022",property_type:"house"},dataType:"json",async:!1}).then(function(data){for(var arrayData=data.results,i=0;i<arrayData.length;i++){0===model.houses.length&&model.houses.push(arrayData[i]);for(var x=0;x<model.houses.length;x++){var dataStreetName=arrayData[i].address.street_name.replace("  "," ").trim(),modelStreetName=model.houses[x].address.street_name.replace("  "," ").trim();if(dataStreetName===modelStreetName&&arrayData[i].address.street_number===model.houses[x].address.street_number){found=!0;break}found=!1}found||model.houses.push(arrayData[i])}}).fail(function(){alert("There has been an error retrieving the data.")})},updatingHouses:function(house){house.fav(house.fav())}},House=function(data){this.id=data.id,this.address=data.address.street_number+" "+data.address.street_name+", "+data.address.postcode+" "+data.address.suburb+" "+data.address.state,this.coords={lat:data.address.latitude,lng:data.address.longitude},this.lat=data.address.latitude,this.lng=data.address.longitude,this.bedrooms=data.bedrooms,this.bathrooms=data.bathrooms,this.description=data.description,this.ensuite=data.ensuite,this.photos=data.photos,this.price=data.price,this.fav=ko.observable(!1)},ViewModel={init:function(){var self=this;model.getData(),this.houseArray=ko.observableArray([]),model.houses.forEach(function(house){self.houseArray.push(new House(house))}),this.updatingfavourites=function(){return model.updatingHouses(this),ViewModel.arrayUpdated(self.houseArray()),view.updateMarker(this),!0}},arrayUpdated:function(){var self=this;return this.houseArray=ko.observableArray([]),model.houses.forEach(function(house){self.houseArray.push(new House(house))}),this.houseArray()},getServices:function(service){if(document.getElementById(service).checked){var places=new google.maps.places.PlacesService(view.map),latlng={lat:view.map.getCenter().lat(),lng:view.map.getCenter().lng()},request={location:latlng,radius:"1000",types:[service]};places.nearbySearch(request,function(results,status){status==google.maps.places.PlacesServiceStatus.OK?view.showServicesMarkers(results,service):status==google.maps.places.PlacesServiceStatus.ZERO_RESULTS?alert("No results"):alert("There was an error "+status)})}else view.hideServicesMarkers(service)}},view={map:{},markers:[],schoolMarkers:[],doctorMarkers:[],shopping_mallMarkers:[],initMap:function(){var center={lat:-33.89285,lng:151.249918};this.map=new google.maps.Map(document.getElementById("map"),{center:center,zoom:12,mapTypeControl:!0,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.TOP_RIGHT}}),this.setMarkers();var menu=document.getElementById("menu"),main=document.querySelector("main"),drawer=document.querySelector(".nav");menu.addEventListener("click",function(e){drawer.classList.toggle("open"),e.stopPropagation()}),main.addEventListener("click",function(){drawer.classList.remove("open")});var schools=document.getElementById("school"),medical=document.getElementById("doctor"),markets=document.getElementById("shopping_mall");schools.addEventListener("change",function(){ViewModel.getServices("school")}),medical.addEventListener("change",function(){ViewModel.getServices("doctor")}),markets.addEventListener("change",function(){ViewModel.getServices("shopping_mall")})},createMarker:function(map,position,title,icon,id){var marker=new google.maps.Marker({map:map,position:position,title:title,animation:google.maps.Animation.DROP,icon:icon,id:id});return marker},setMarkers:function(){for(var self=this,bounds=new google.maps.LatLngBounds,locations=ViewModel.arrayUpdated(),i=0;i<locations.length;i++){locations[i].fav()?self.marker=self.createMarker(view.map,locations[i].coords,locations[i].address,"images/star-3.png",locations[i].id):self.marker=self.createMarker(view.map,locations[i].coords,locations[i].address,"images/home-2.png",locations[i].id),view.markers.push(self.marker);var infowindow=new google.maps.InfoWindow;self.marker.addListener("click",function(copyLocations){return function(){self.setInfoWindows(this,infowindow,copyLocations,null)}}(locations[i]))}for(var i=0;i<view.markers.length;i++)view.markers[i].setMap(view.map),bounds.extend(view.markers[i].position);view.map.fitBounds(bounds)},updateMarker:function(house){for(var indexSelected,self=this,i=0;i<view.markers.length;i++)if(view.markers[i].id===house.id){indexSelected=i;break}var markerSelected=view.markers[indexSelected];markerSelected.setMap(null),view.markers.splice(indexSelected,1),markerSelected=null,house.fav()?(marker=this.createMarker(view.map,house.coords,house.address,"images/star-3.png",house.id),view.markers.splice(indexSelected,0,marker)):(marker=this.createMarker(view.map,house.coords,house.address,"images/home-2.png",house.id),view.markers.splice(indexSelected,0,marker));var infowindow=new google.maps.InfoWindow;marker.addListener("click",function(copyHouse){return function(){self.setInfoWindows(this,infowindow,copyHouse,null)}}(house))},setInfoWindows:function(marker,infowindow,house,service){infowindow.marker!=marker&&infowindow.open(view.map,marker),infowindow.setContent(""),infowindow.marker=marker,infowindow.addListener("closeclick",function(){infowindow.marker=null});var content;if(house){var streetview="https://www.google.com/maps/embed/v1/streetview?location="+house.lat+","+house.lng+"&key=AIzaSyC4dYdTtAuclPLAGpEg-1UQ947LrilnwkI";$(".infowindow .bgimg").attr("src",house.photos[1].versions.thumb.url),$(".infowindow h2").html(house.address),$(".bed").html("Bedrooms: "+house.bedrooms),$(".bath").html("Bathrooms: "+house.bathrooms),$(".ensuite").html("Ensuite: "+house.ensuite),$(".price").html("Price: $"+house.price),$(".description").html(house.description),$(".street").html('<iframe class="view" width="400" height="250" frameborder="0" style="border:0" src="" allowfullscreen></iframe>'),$(".view").attr("src",streetview),content=$(".infowindow").html()}else{var streetview="https://maps.googleapis.com/maps/api/streetview?location="+marker.title+"&key=AIzaSyC4dYdTtAuclPLAGpEg-1UQ947LrilnwkI&size=200x200";$(".infowindowservice .bgimg").attr("src",streetview),$(".infowindowservice h2").html(marker.title),content=$(".infowindowservice").html()}infowindow.setContent(content)},hideInfowindows:function(){for(var i=0;i<view.markers.length;i++)view.markers[i].close(null);view.markers=[]},showServicesMarkers:function(results,service){for(var i=0;i<results.length;i++){var title=results[i].name+String.fromCharCode(13)+results[i].vicinity;marker=this.createMarker(view.map,results[i].geometry.location,title,"images/"+service+".png",i),"school"===service?view.schoolMarkers.push(marker):"doctor"===service?view.doctorMarkers.push(marker):view.shopping_mallMarkers.push(marker);var infowindow=new google.maps.InfoWindow;marker.addListener("click",function(){view.setInfoWindows(this,infowindow,null,service)})}},hideServicesMarkers:function(service){if("school"===service&&view.schoolMarkers.length>0){for(var i=0;i<view.schoolMarkers.length;i++)view.schoolMarkers[i].setMap(null);view.schoolMarkers=[]}else if("doctor"===service&&view.doctorMarkers.length>0){for(var i=0;i<view.doctorMarkers.length;i++)view.doctorMarkers[i].setMap(null);view.doctorMarkers=[]}else{for(var i=0;i<view.shopping_mallMarkers.length;i++)view.shopping_mallMarkers[i].setMap(null);view.shopping_mallMarkers=[]}}};ko.applyBindings(new ViewModel.init);